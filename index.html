<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search by Login ID / Month</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">Search Data by Login ID or Month</h1>

    <div class="flex gap-2 mb-4">
      <select id="monthSelect" class="p-3 rounded border bg-white">
        <option value="">Select Month (Sheet)</option>
      </select>
      <input id="search" type="text" placeholder="Search Login ID..."
        class="flex-1 p-3 rounded border" />
      <button onclick="clearSearch()" class="px-4 py-2 bg-white border rounded">Clear</button>
    </div>

    <div id="status" class="mb-4 text-sm text-gray-600"></div>

    <div class="overflow-x-auto">
      <table id="table" class="min-w-full bg-white rounded shadow divide-y"></table>
    </div>
  </div>

<script>
  let fullData = [];
  let sheetList = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadSheetList();
    document.getElementById("search").addEventListener("input", filterData);
    document.getElementById("monthSelect").addEventListener("change", filterByMonth);
  });

  async function loadSheetList() {
    try {
      setStatus("Loading sheet list from Google Sheet...");
      const url = "https://docs.google.com/spreadsheets/d/1f-nRX7AbZnnrm3UGEuXQIt4rZKzx1BonAOxaKvDDYSk/export?format=xlsx";
      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch sheet — status " + res.status);
      const array = await res.arrayBuffer();
      const wb = XLSX.read(array, { type: "array" });
      sheetList = wb.SheetNames;
      console.log("Available sheets:", sheetList);
      const sel = document.getElementById("monthSelect");
      sheetList.forEach(s => {
        sel.innerHTML += `<option value="${s}">${s}</option>`;
      });
      setStatus("Sheet list loaded. Choose a month or enter Login ID.");
    } catch (e) {
      console.error("Error loading sheet list:", e);
      setStatus("Error: " + e.message);
    }
  }

  async function loadExcel(sheetName = null) {
    try {
      setStatus("Loading sheet data" + (sheetName ? " — " + sheetName : "") + "...");
      const url = "https://docs.google.com/spreadsheets/d/1f-nRX7AbZnnrm3UGEuXQIt4rZKzx1BonAOxaKvDDYSk/export?format=xlsx";
      const res = await fetch(url);
      if (!res.ok) throw new Error("Fetch failed, status " + res.status);
      const array = await res.arrayBuffer();
      const wb = XLSX.read(array, { type: "array" });
      const target = (sheetName && wb.SheetNames.includes(sheetName))
        ? sheetName
        : wb.SheetNames[0];
      const sheet = wb.Sheets[target];
      fullData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    } catch (err) {
      console.error("Error loading Excel data:", err);
      fullData = [];
      setStatus("Error loading data: " + err.message);
    }
  }

  function filterData() {
    const q = document.getElementById("search").value.trim().toLowerCase();
    const month = document.getElementById("monthSelect").value;
    if (month) return filterByMonth();
    if (!q) {
      renderTable([]);
      setStatus("Enter a Login ID to search.");
      return;
    }
    const loginKey = fullData.length
      ? Object.keys(fullData[0]).find(h => h.toLowerCase() === "login id" || h.toLowerCase() === "loginid")
      : null;
    if (!loginKey) {
      setStatus("Error: No \"Login ID\" column found.");
      renderTable([]);
      return;
    }
    const filtered = fullData.filter(r => (r[loginKey] || "").toString().toLowerCase() === q);
    renderTable(filtered);
    setStatus(`Showing ${filtered.length} matched result(s).`);
  }

  async function filterByMonth() {
    const month = document.getElementById("monthSelect").value;
    if (!month) {
      renderTable([]);
      setStatus("Select a month (sheet) to display.");
      return;
    }
    await loadExcel(month);
    renderTable(fullData);
    setStatus(`Loaded sheet: ${month} (${fullData.length} rows).`);
  }

  function renderTable(rows) {
    const table = document.getElementById("table");
    table.innerHTML = "";
    if (!rows || rows.length === 0) {
      table.innerHTML = "<tr><td class='p-4 text-center text-gray-500'>No data to display</td></tr>";
      return;
    }
    const headers = Object.keys(rows[0]);
    let thead = "<thead class='bg-gray-200'><tr>";
    headers.forEach(h => thead += `<th class='px-4 py-2 text-left'>${h}</th>`);
    thead += "</tr></thead>";

    let tbody = "<tbody>";
    rows.forEach(r => {
      tbody += "<tr class='border-t'>";
      headers.forEach(h => tbody += `<td class='px-4 py-2'>${r[h]}</td>`);
      tbody += "</tr>";
    });
    tbody += "</tbody>";

    table.innerHTML = thead + tbody;
  }

  function clearSearch() {
    document.getElementById("search").value = "";
    document.getElementById("monthSelect").value = "";
    renderTable([]);
    setStatus("Enter Login ID or select sheet to display.");
  }

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }
</script>
</body>
</html>
