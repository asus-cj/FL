<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>ASUS CJ - Rocket Program</title>

  <!-- ================= SECURITY HEADERS ================= -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' https://cdn.jsdelivr.net;
      style-src 'self' https://cdn.jsdelivr.net;
      img-src 'self' https://upload.wikimedia.org data:;
      connect-src https://docs.google.com;
      object-src 'none';
      base-uri 'none';
      frame-ancestors 'none';
      form-action 'none';
    ">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- ================= DEPENDENCIES ================= -->
  <script
    src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"
    defer>
  </script>

  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet">
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-center mb-4">
      <img
        src="https://upload.wikimedia.org/wikipedia/commons/2/2e/ASUS_Logo.svg"
        alt="ASUS Logo"
        class="h-16"
        loading="lazy">
    </div>

    <h1 class="text-3xl font-bold mb-4 text-center">
      Asus Rocket Program
    </h1>

    <div class="flex gap-3 mb-4">
      <select id="monthSelect" class="p-3 rounded border w-1/3">
        <option value="">Pilih bulan</option>
      </select>

      <input
        id="search"
        type="text"
        class="p-3 border rounded w-2/3"
        placeholder="Masukkan ID iChannel"
        maxlength="30"
        autocomplete="off">

      <button
        id="searchBtn"
        class="p-3 bg-blue-600 text-white rounded">
        Cari
      </button>
    </div>

    <p id="status" class="text-gray-600 mb-3"></p>

    <div class="overflow-x-auto">
      <table id="resultTable" class="min-w-full text-sm border hidden">
        <thead class="bg-gray-200"></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const sheetURL =
    "https://docs.google.com/spreadsheets/d/1f-nRX7AbZnnrm3UGEuXQIt4rZKzx1BonAOxaKvDDYSk/export?format=xlsx";

  let fullData = [];

  const statusEl = document.getElementById("status");
  const table = document.getElementById("resultTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const monthSelect = document.getElementById("monthSelect");
  const searchInput = document.getElementById("search");

  document.addEventListener("DOMContentLoaded", init);

  function init() {
    document.getElementById("searchBtn").addEventListener("click", filterData);
    monthSelect.addEventListener("change", loadMonth);
    loadSheetList();
  }

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  function clearTable() {
    thead.textContent = "";
    tbody.textContent = "";
    table.classList.add("hidden");
  }

  function renderTable(rows) {
    clearTable();
    if (!rows.length) return;

    const headers = Object.keys(rows[0]);
    const trHead = document.createElement("tr");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      th.className = "p-2 border";
      trHead.appendChild(th);
    });

    thead.appendChild(trHead);

    rows.forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");
        td.textContent = row[h] ?? "";
        td.className = "p-2 border";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.classList.remove("hidden");
  }

  async function loadSheetList() {
    try {
      const res = await fetch(sheetURL, { mode: "cors" });
      if (!res.ok) throw new Error();

      const buffer = await res.arrayBuffer();
      const wb = XLSX.read(buffer, { type: "array" });

      wb.SheetNames.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        monthSelect.appendChild(opt);
      });

      setStatus("Pilih bulan.");
    } catch {
      setStatus("Gagal memuat database.");
    }
  }

  async function loadMonth() {
    const month = monthSelect.value;
    clearTable();

    if (!month) {
      setStatus("Pilih bulan terlebih dahulu.");
      return;
    }

    try {
      const res = await fetch(sheetURL);
      const buffer = await res.arrayBuffer();
      const wb = XLSX.read(buffer, { type: "array" });

      fullData = XLSX.utils.sheet_to_json(wb.Sheets[month]);
      setStatus(`Bulan "${month}" dipilih.`);
    } catch {
      setStatus("Gagal memuat data bulan.");
    }
  }

  function filterData() {
    const q = searchInput.value.trim();

    if (q.length < 4) {
      setStatus("Masukkan ID iChannel yang valid.");
      return;
    }

    if (!fullData.length) {
      setStatus("Data belum tersedia.");
      return;
    }

    const key = Object.keys(fullData[0])
      .find(k => k.toLowerCase().replace(/\s/g, "") === "loginid");

    if (!key) {
      setStatus("Kolom Login ID tidak ditemukan.");
      return;
    }

    const result = fullData.filter(r =>
      String(r[key]).toLowerCase() === q.toLowerCase()
    );

    renderTable(result);
    setStatus(`Menampilkan ${result.length} data.`);
  }
})();
</script>
</body>
</html>
