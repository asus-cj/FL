<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Data</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-3xl font-bold mb-4">Asus Rocket Program Achievement</h1>

    <!-- Month Selection + Login ID Input -->
    <div class="flex gap-3 mb-4">
      <select id="monthSelect" class="p-3 rounded border bg-white w-1/3">
        <option value="">Select Month (Sheet)</option>
      </select>

      <input id="search" type="text" placeholder="Enter Login ID" class="p-3 border rounded w-2/3" />
    </div>

    <!-- Status -->
    <p id="status" class="text-gray-600 mb-3"></p>

    <!-- Table Container -->
    <div class="overflow-x-auto">
      <table id="resultTable" class="min-w-full text-sm border hidden">
        <thead class="bg-gray-200"></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const sheetURL = "https://docs.google.com/spreadsheets/d/1f-nRX7AbZnnrm3UGEuXQIt4rZKzx1BonAOxaKvDDYSk/export?format=xlsx";
  let fullData = [];
  let sheetList = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadSheetList();
    document.getElementById("search").addEventListener("input", filterData);
    document.getElementById("monthSelect").addEventListener("change", filterByMonth);
  });

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }

  function renderTable(rows) {
    const table = document.getElementById("resultTable");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      table.classList.add("hidden");
      return;
    }

    const headers = Object.keys(rows[0]);
    thead.innerHTML = `<tr>${headers.map(h => `<th class='p-2 border'>${h}</th>`).join("")}</tr>`;
    tbody.innerHTML = rows.map(r => `<tr>${headers.map(h => `<td class='p-2 border'>${r[h] ?? ""}</td>`).join("")}</tr>`).join("");

    table.classList.remove("hidden");
  }

  async function loadSheetList() {
    try {
      const res = await fetch(sheetURL);
      const array = await res.arrayBuffer();
      const wb = XLSX.read(array, { type: "array" });
      sheetList = wb.SheetNames;

      const sel = document.getElementById("monthSelect");
      sheetList.forEach(name => {
        sel.innerHTML += `<option value="${name}">${name}</option>`;
      });

      setStatus("Select a month.");
    } catch (err) {
      console.error(err);
      setStatus("Failed to load sheet list.");
    }
  }

  async function loadExcel(sheetName) {
    const res = await fetch(sheetURL);
    const array = await res.arrayBuffer();
    const wb = XLSX.read(array, { type: "array" });

    const selectedSheet = sheetName && wb.SheetNames.includes(sheetName)
        ? sheetName
        : wb.SheetNames[0];

    const sheet = wb.Sheets[selectedSheet];
    fullData = XLSX.utils.sheet_to_json(sheet);
  }

  async function filterByMonth() {
    const month = document.getElementById("monthSelect").value;

    if (!month) {
      renderTable([]);
      setStatus("Select a month to continue.");
      return;
    }

    await loadExcel(month);
    renderTable([]);
    setStatus(`Month "${month}" selected. Now enter a Login ID.`);
  }

  function filterData() {
    const q = document.getElementById("search").value.trim().toLowerCase();
    const month = document.getElementById("monthSelect").value;

    if (!month) {
      renderTable([]);
      setStatus("Select a month first.");
      return;
    }

    if (!q) {
      renderTable([]);
      setStatus("Enter a Login ID to search.");
      return;
    }

    if (!fullData.length) {
      setStatus("No data loaded.");
      return;
    }

    const loginKey = Object.keys(fullData[0]).find(h => h.toLowerCase() === "login id" || h.toLowerCase() === "loginid");
    if (!loginKey) {
      setStatus("Login ID column not found.");
      return;
    }

    const filtered = fullData.filter(r => String(r[loginKey]).toLowerCase() === q);
    renderTable(filtered);
    setStatus(`Showing ${filtered.length} result(s).`);
  }
</script>
</body>
</html>
